---
title: "Boosted regressions for climate change and sdm"
author: "Victoria Prescott"
date: "7/25/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r eval=FALSE}
#You will need the following packages:
library("dismo", lib.loc="~/R/library")
library("gbm", lib.loc="~/R/library")
library("maps", lib.loc="~/R/library")
library("mapdata", lib.loc="~/R/library")
library("maptools", lib.loc="~/R/library")
library("rgdal", lib.loc="~/R/library")
```

```{r eval=FALSE}
current.list=list.files(path="pathway to files", 
                        pattern="tif$", full.names=TRUE )
current=stack(current.list)
```

```{r eval=FALSE}
#bring in coordinates of species of interest, and switch columns so that latitude is first
a.torren.coords <- read.csv("pathways to files")
a.torren.coords<-a.torren.coords[c("Latitude","Longitude")]
```

```{r eval=FALSE}
#create presence training and test data
set.seed(0)
group=kfold(a.torren.coords, 5)
pres_train=a.torren.coords[group!=1,]
pres_test=a.torren.coords[group==1,]
```

```{r eval=FALSE}
#create background training and test data (in lieu of absence data)
set.seed(10)
ext=extent(6,16,46,50)
backg=randomPoints(current, n=500,ext=ext, extf=1.25)
colnames(backg)=c('Longitude','Latitude')
group=kfold(backg,5)
backg_train=backg[group!=1,]
backg_test=backg[group==1,]
```

```{r eval=FALSE}
#create a plot, showing just first layer and plot to check data
r=raster(current,1)
plot(!is.na(r), col=c('white','light grey'), legend=FALSE)
points(backg_train, pch='-', cex=0.5, col='yellow')
points(backg_test, pch='+', cex=0.5, col='black')
points(pres_train, pch='+', col='green')
points(pres_test, pch='+', col='blue')
```

```{r eval=FALSE}
#create data frame with presence and background training coordinates
#extract environmental data at those coordinates
backg_train_current<-extract(current, backg_train)
pres_train_current<-extract(current, pres_train)
pres_backg_train<-c(rep(1,nrow(pres_train_current)), 
                   rep(0, nrow(backg_train_current)))
train<-rbind(pres_train_current, backg_train_current)
envtrain<-data.frame(cbind(pa=pres_backg_train, train))
```

```{r eval=FALSE}
#do the same for test data
backg_test_current<-extract(current, backg_test)
pres_test_current<-extract(current, pres_test)
pres_backg_test<-c(rep(1,nrow(pres_test_current)), 
                   rep(0, nrow(backg_test_current)))
test<-rbind(pres_test_current, backg_test_current)
envtest<-data.frame(cbind(pa=pres_backg_test, test))
```

```{r eval=FALSE}
#run a model, lower the learning rate if you get the algorithm warning
a.torren.tc5.lr001.train<-gbm.step(data=envtrain, gbm.x=2:20, gbm.y=1,
                                 family="bernoulli", tree.complexity = 5,
                                  learning.rate=0.001, bag.fraction=0.5)
```

```{r eval=FALSE}
#determine how well the test data does with this model
pr=predict(a.torren.tc5.lr001.train,envtest, 
           n.trees=a.torren.tc5.lr001.train$gbm.call$best.trees,
           type="response")
calc.deviance(obs=envtest$pa, pred=pr, calc.mean = TRUE)
d<-cbind(envtest$pa, pr)
pres<-d[d[,1]==1,2]
abs<-d[d[,1]==0,2]
e<-evaluate(p=pres, a=abs)
e
threshold(e)
sensitivity<-sum(pres>=0.7156226)/length(pres) 
  #use the desired threshold value from previous step
specificity<-sum(abs<0.7156226)/length(abs)
```

```{r eval=FALSE}
#run the model across the world (compare climate at gps points to the entire world)
#will eventually have to crop this to the great lakes region
#this takes quite a while to run
p<-predict(current, a.torren.tc5.lr001.train,
          n.trees=a.torren.tc5.lr001.train$gbm.call$best.trees,
          type="response")
```

```{r eval=FALSE}
#plot map
predict_current_mask=mask(predict_current, raster(current,1))
plot(p, main="A. torren-BRT prediction")
```

```{r eval=FALSE}
#to crop to just North America
cropped<-raster("E:/postdoc/Mod_WorldClim/ModLayers_2050_45/mod_rasters/mod_bio_1.tif")
current_NA<-crop(predict_current_mask, cropped)
current_NA<-mask(current_NA,cropped)
plot(current_NA,
     main="ADD TITLE")
```

```{r eval=FALSE}
#use future projection RCP 45 2050
rcp45.50.list=list.files(path="E:/postdoc/WorldClim/2050/GF-RCP45/gf45bi50/", 
                         pattern="tif$", full.names=TRUE )
rcp45.50=stack(rcp45.50.list)
```

```{r eval=FALSE}
#Once again, the next step takes hours to run
predict_RCP45_50<-predict(rcp45.50, a.torren.tc5.lr01.train,
            n.trees=a.torren.tc5.lr01.train$gbm.call$best.trees,
            type="response")
predict_RCP45_50_cropped<-crop(predict_RCP45_50,cropped)
predict_RCP45_50_mask<-mask(predict_RCP45_50_cropped,cropped)
plot(predict_RCP45_50_mask, 
     xlim=c(-180,-20), ylim=c(10,90),
     main="ADD TITLE")
```
![A.torrentium.45.2050.png](/home/vaprescott/ClimateAndInvasiveRA/A.torrentium.45.2050.png)
```{r eval=FALSE}
colors<-c("blue","lightblue"," green", "yellow", "red")
text(cex.main=1.25,add=TURE)
test<-stack(r3,rcp45.70_mask)
animation<-animate(test, pause=1, n=100, 
                   xlim=c(-180,-20), 
                   ylim=c(10,90), 
                   col=colors,
                   maxpixels=5000)
```
 
